# BLE AT Command Tester - 수정된 계획 요약

## 🔄 주요 변경사항

### 1. Native 라이브러리 명시
- **라이브러리**: `libVpos3893_release_20250930.aar`
- **위치**: `app/libs/` 디렉토리
- **로딩**: build.gradle에서 flatDir 방식으로 로드

### 2. 개발 언어 변경
- **언어**: Java → **Kotlin**
- **코루틴 사용**: 백그라운드 작업 처리
- **ViewBinding**: 레이아웃 바인딩 활성화

### 3. Scan 기능 단순화 ⭐
**변경 전**: 스캔 결과 → 별도 팝업 (RecyclerView)으로 디바이스 목록 표시
**변경 후**: 스캔 결과 → **터미널에 직접 출력** (Serial USB Terminal 방식)

#### 제거된 컴포넌트:
- ❌ `ScanResultDialog.kt`
- ❌ `ScanResultAdapter.kt`
- ❌ `BleDevice.kt` 데이터 모델
- ❌ `item_scan_result.xml`
- ❌ `dialog_scan_result.xml`

#### 스캔 동작 방식:
```
1. "Scan" 버튼 클릭 (isScanning == false)
   ↓
2. 스캔 파라미터 입력 팝업
   ↓
3. AT+STARTNEWSCAN 전송
   ↓
4. 버튼 → "Stop Scan" (빨간색)
   ↓
5. 터미널에 스캔 결과 실시간 출력 (노란색):
   "< SCAN: AA:BB:CC:DD:EE:FF, -65, MyDevice, 02010611FF..."
   "< SCAN: 11:22:33:44:55:66, -72, Unknown, 0201061AFF..."
   ↓
6. "Stop Scan" 버튼 클릭 → AT+STOPSCAN 전송
   ↓
7. 버튼 → "Scan" (원래 상태)
```

---

## 📁 최종 프로젝트 구조

```
ble_at_command_tester/
├── app/
│   ├── libs/
│   │   └── libVpos3893_release_20250930.aar  ← Native 라이브러리
│   ├── src/
│   │   ├── main/
│   │   │   ├── kotlin/com/example/bleattest/
│   │   │   │   ├── MainActivity.kt
│   │   │   │   ├── AtCommandManager.kt
│   │   │   │   ├── TerminalAdapter.kt
│   │   │   │   ├── InputDialogFragment.kt
│   │   │   │   └── models/
│   │   │   │       ├── TerminalLog.kt
│   │   │   │       └── AtCommandResult.kt
│   │   │   ├── res/
│   │   │   │   ├── layout/
│   │   │   │   │   ├── activity_main.xml
│   │   │   │   │   ├── item_terminal_log.xml
│   │   │   │   │   └── dialog_input.xml
```

---

## 🎨 터미널 로그 색상

```kotlin
enum class LogType {
    SEND,      // 송신 (파란색)   → "> AT+COMMAND\r\n"
    RECEIVE,   // 수신 (초록색)   → "< OK"
    SCAN,      // 스캔 (노란색)   → "< SCAN: MAC, RSSI, Name..."
    ERROR,     // 에러 (빨간색)   → "Error: Send failed"
    INFO       // 정보 (회색)     → "Connecting..."
}
```

---

## 🔧 핵심 구현 포인트

### 1. AtCommandManager.kt
```kotlin
class AtCommandManager {
    var isScanning: Boolean = false  // 스캔 상태 관리
    
    fun sendAtCommand(command: String): Int {
        // "+++"는 CRLF 없이, 나머지는 "\r\n" 추가
        val cmd = if (command == "+++") command 
                  else command + "\r\n"
        return At.Lib_ComSend(cmd.toByteArray(), cmd.length)
    }
    
    fun receiveAtResponse(): String? {
        val buffer = ByteArray(1024)
        val ret = At.Lib_ComRecvAT(buffer, buffer.size)
        return if (ret > 0) String(buffer, 0, ret) else null
    }
}
```

### 2. MainActivity.kt - 스캔 버튼 처리
```kotlin
private var isScanning = false

private fun setupScanButton() {
    binding.btnScan.setOnClickListener {
        if (!isScanning) {
            // 스캔 시작
            showScanInputDialog()
        } else {
            // 스캔 중지
            stopScan()
        }
    }
}

private fun startScan(params: ScanParams) {
    isScanning = true
    binding.btnScan.text = "Stop Scan"
    binding.btnScan.setBackgroundColor(Color.RED)
    
    atCommandManager.startScan(params)
    addLogToTerminal("> ${params.toAtCommand()}", LogType.SEND)
}

private fun stopScan() {
    isScanning = false
    binding.btnScan.text = "Scan"
    binding.btnScan.setBackgroundColor(defaultColor)
    
    atCommandManager.stopScan()
    addLogToTerminal("> AT+STOPSCAN\r\n", LogType.SEND)
}
```

### 3. 응답 수신 - 스캔 결과 구분
```kotlin
private fun startReceiving() {
    GlobalScope.launch(Dispatchers.IO) {
        while (isReceiving) {
            atCommandManager.receiveAtResponse()?.let { response ->
                withContext(Dispatchers.Main) {
                    // 스캔 결과인지 판단
                    val logType = when {
                        response.startsWith("SCAN:") -> LogType.SCAN
                        else -> LogType.RECEIVE
                    }
                    addLogToTerminal("< $response", logType)
                }
            }
            delay(100)
        }
    }
}
```

---

## 📱 UI 화면 예시

```
┌─────────────────────────────────────┐
│  BLE AT Command Tester       [≡]   │
├─────────────────────────────────────┤
│  ┌──────────────────────────────┐  │
│  │ [14:30:25.123] > AT+GETMAC   │  │ ← 파란색
│  │ [14:30:25.345] < MAC: AA:..  │  │ ← 초록색
│  │ [14:30:25.456] < OK          │  │ ← 초록색
│  │ [14:30:30.100] > AT+START... │  │ ← 파란색
│  │ [14:30:30.300] < SCAN: AA... │  │ ← 노란색
│  │ [14:30:30.500] < SCAN: 11... │  │ ← 노란색
│  │ [14:30:30.700] < SCAN: 22... │  │ ← 노란색
│  └──────────────────────────────┘  │
│                                     │
│  ┌──────────┐ ┌──────────┐         │
│  │ Enable   │ │ Get MAC  │         │
│  │ Master   │ │          │         │
│  └──────────┘ └──────────┘         │
│  ┌──────────┐ ┌──────────┐         │
│  │Stop Scan │ │ Connect  │         │ ← 스캔 중일 때
│  │   🔴     │ │          │         │    빨간색 표시
│  └──────────┘ └──────────┘         │
└─────────────────────────────────────┘
```

---

## ⚡ 장점

1. **구조 단순화**: 별도 팝업 없이 터미널에 모든 것 표시
2. **Serial Terminal 스타일**: 실제 시리얼 터미널처럼 직관적
3. **개발 속도 향상**: 제거된 컴포넌트로 개발 시간 단축
4. **디버깅 용이**: 모든 로그가 한 화면에 시간순으로 표시
5. **메모리 효율**: 별도 디바이스 리스트 관리 불필요

---

## 📝 개발 순서 (단순화)

### Phase 1 (1-2일)
- 프로젝트 생성 (Kotlin)
- libVpos3893_release_20250930.aar 통합
- 기본 터미널 UI + RecyclerView

### Phase 2 (2일)
- AtCommandManager 구현 (송수신 로직)
- 5개 버튼 기능 구현
- 스캔 상태 관리 (토글 버튼)

### Phase 3 (1일)
- InputDialogFragment (범용 입력 팝업)
- 터미널 색상 적용 (SCAN 타입 추가)
- 이전 입력값 저장

### Phase 4 (1일)
- 실제 EFR32BG22 모듈 테스트
- 에러 처리 및 최적화

**예상 총 기간**: 5-6일

---

## ✅ 완료 체크리스트

- [x] Native 라이브러리 정보 추가
- [x] Kotlin 언어로 변경
- [x] 스캔 결과를 터미널 출력 방식으로 단순화
- [x] 불필요한 컴포넌트 제거
- [x] 스캔 버튼 토글 기능 추가
- [x] LogType에 SCAN 추가
- [x] 프로젝트 구조 정리
- [x] 개발 순서 업데이트

---

## 🚀 다음 단계

1. 계획서 검토 완료
2. 신규 레포 생성
3. 기본 프로젝트 구조 셋업
4. libVpos3893_release_20250930.aar 통합
5. MainActivity + 터미널 UI 구현
6. 순차적으로 기능 개발

---

**준비 완료! 구현 시작하시겠습니까?** 🎯
